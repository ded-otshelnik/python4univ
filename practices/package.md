# Пакеты и приложения в языке Python: структура, сборка, распространение

Как мультипарадигменный язык программирования, Python разрабатывается для использования в разных сферах, например, для разработки моделей ИИ, игр или веб-сайтов. Гибкость Python - причина, почему, в первую очередь, перед непосредственной разработкой необходимо озаботиться вопросом структуры проекта, соответствующего окружения, где проект работает, чтобы предотвратить появление проблем при создании и использовании.

## Содержание

- [Пакеты и приложения в языке Python: структура, сборка, распространение](#пакеты-и-приложения-в-языке-python-структура-сборка-распространение)
  - [Содержание](#содержание)
  - [Что такое пакет в Python?](#что-такое-пакет-в-python)
  - [Структура пакетов](#структура-пакетов)
    - [Документация](#документация)
    - [Pyproject.toml и файлы исходного кода](#pyprojecttoml-и-файлы-исходного-кода)
  - [Ссылки](#ссылки)

## Что такое пакет в Python?

**Пакеты** в Python - ключевой элемент языка, определяющий путь повторного использования и распространения кода **и для библиотек, и для приложений**.

Обычно они загружаются через специальные утилиты - `pip` (официальный менеджер пакетов) и `conda` (менеджер виртуальных сред, а также их пакетов). К примеру, когда вы делаете команду `pip install numpy` (или `conda install numpy` в активной виртуальной среде), менеджер ищет в специальном хранилище (в случае conda - в **каналах**, которые почти идентичны)- **[Python Packaging Index (PyPI)](https://pypi.org/)** - где размещаются **дистрибутивы** программных проектов. Однако, менеджеры поддерживают установку из сторонних источников, в частности, через указание URL, откуда можно скачать дистрибутив пакета. Например, установка пакета PyTorch осуществляется следующим образом:

```bash
pip install torch --index-url https://download.pytorch.org/whl/cu126
```

Как выглядит дистрибутив пакета для библиотеки? Обычно он состоит из 3 частей:

1. **Файлы модулей**: они имеют расширение .py и зависят **только** от стандартной библиотеки. Единственное, о чем требуется думать - версия языка, на котором написан код.
2. **Файлы дистрибутива исходников**. В проектах код состоит из множества файлов .py, находящихся в некоторой иерархии или структуре, и имеет зависимости от библиотек и их конкретных версий. Через встроенные инструменты языка можно объединить код и его зависимости в **дистрибутивный пакет исходников (Source Distribution Package)**, или **sdist**. Питоновские sdist - это **сжатый архив .tar.gz**, который содержит **только Python-код**.
3. **Файлы бинарного дистрибутива**. Ключ к популярности Python состоит в возможности интеграции с окружающей экосистемой и ПО, написанном на таких языках, как C, C++, Fortran, Rust и т.д. Так, например, пакет Numpy опирается на библиотеку BLAS, написанную на языке Fortran. Поскольку не у всех разработчиков есть инструменты для сборки этих компонентов (компиляторы, библиотеки и т.п.), Python придумал специальный формат диструтива - **wheel** - идеей которого является **связать** код на Python и скомпилированные артифакты (бинарные файлы, скомпилированные библиотеки, и т.п.). Обычно wheel публикуют вместе с sdist (если есть возможность), поскольку в этом случае sdist будет содержать **не только Python-код, но и код другого языка**, который можно собрать собственными руками, чтобы была во работать с кодом на разных платформах. Python и PyPI поддерживают оба формата вместе.

<img src="images/package_structure.png" alt="package structure" width="600"/>

Дистрибутивы для приложения обычно зависят от конкретных фреймворков и платформ, которые используются, поэтому сборка подобного дистрибутива будет зависеть от них.

Однако, довольно часто можно создать для проекта **исполняемый файл (executable file - .exe для Windows)**, которые можно выполнять в отрыве от среды как единый файл, инкапсулируя в него интерпретатор Python, зависимости и код приложения. Такой подход называется **freezing**. Делать в случае установки *для одного пользователя* это можно через следующие инструменты:

- [pyInstaller](https://pyinstaller.readthedocs.io/en/stable/) - кросс-платформенный
- [cx_Freeze](https://marcelotduarte.github.io/cx_Freeze/) - кросс-платформенный
- [constructor](https://github.com/conda/constructor) - для установки через консоль
- [py2exe](http://www.py2exe.org/) - только Windows
- [py2app](https://py2app.readthedocs.io/en/latest/) - только MacOS
- [osnap](https://github.com/jamesabel/osnap) - Windows и Mac
- [pynsist](https://pypi.org/project/pynsist/) - только Windows

Далее будет рассматриваться структура пакета на примере библиотек, однако, общая структура также работает и в случае приложений.

[К оглавлению](#содержание)

## Структура пакетов

Ниже приведен шаблон структуры пакета, который обычно применяется при создании:

```text
package-demo
├── CHANGELOG.md               ┐
├── CONDUCT.md                 │
├── CONTRIBUTING.md            │
├── docs                       │
│   ├── changelog.md           │
│   ├── conduct.md             │
│   ├── conf.py                │ 
│   ├── contributing.md        │ Package documentation
│   ├── example.ipynb          │
│   ├── index.md               │
│   ├── make.bat               │
│   ├── Makefile               │
│   └── requirements.txt       │
├── LICENSE                    │
├── README.md                  ┘
├── pyproject.toml             ┐ 
├── src                        │
│   └── package-demo           │ Package source code, metadata,
│       ├── __init__.py        │ and build instructions 
│       ├── moduleA.py         │
│       └── moduleB.py         ┘
└── tests                      ┐
    └── test_demo.py           ┘ Package tests
```

Структура пакетов выглядит следующим образом:

### Документация

К документации относится следующее:

|Документация|Местоположение (по умолчанию)|Описание|
|:---    | :--- | :---      |
|README|Корень проекта|Предоставляет информацию о пакете, например, как установить, или как использовать.|
|LICENSE|Корень проекта|Определяет права на интеллектуальную собственность и правила использования и дистрибуции.|
|Contributing guidelines|Корень проекта|Объясняет правила, как можно сделать вклад в проект|
|Code of conduct|Корень проекта|Определяет стандарты как корректно участвовать в развитии проекта|
|Changelog|Корень проекта|Хронологически упорядоченный список записанных изменений в пакете с течением времени, обычно организовывая по версиям|
|Docstrings\index{docstring}| *.py* файлы |Текст, который находится в первых строках функции, метода, класса или модуля Python, описывающий что делает код и как его использовать. Доступен через вызов команды `help()`.|
|Примеры|папка *`docs/`* |Пошаговые примеры, показывающие как работает пакет в деталях.|
|Описание прикладного программного интерфейса (API)|папка *`docs/`* | Упорядоченный список с описанием функциональности пакета (функций, классов, и т.п.) вместе с коротким описанием того, что код делает и как его использовать. Обычно генерируется автоматически из docstrings через автогенераторы документации, например, [Sphinx](https://www.sphinx-doc.org/en/master/)|

Обычно порядок создания документации выглядит так:

1. **Написать документацию** в коде или в формате отдельных файлов.
2. **Собрать документацию**: скомпилировать и отрендерить в HTML через автогенератор
3. **Разместить документацию** на специально выделенном сайте.

Более подробно про то, как делать документацию, можно почитать [здесь](https://py-pkgs.org/03-how-to-package-a-python#writing-documentation).

### Pyproject.toml и файлы исходного кода

После документации

**pyproject.toml** - конфигурационный файл в формате *.toml*, который содержит **метаданные** пакета в формате таблиц. К метаданным относятся:

1. **Зависимости системы сборки**: специальная таблица, в которым указывается система сборки, а также требования для нее (обычно - наличие пакета сборщика).
2. **Зависимости проекта**: пакеты, библиотеки, или фреймворки, которые должны быть установлены в среду при сборке пакета. Поддерживается указание версий пакетов, как это обычно выглядит в файлах *requirements.txt*.
3. **Метаданные проекта**: данные о проекте

[К оглавлению](#содержание)

## Ссылки

Материалы взяты из следующих источников:

- [Python Packaging Index](https://packaging.python.org/en/latest/)
- [T.Beuzen, T.Timbers: Python Packages](https://py-pkgs.org/welcome)

[К оглавлению](#содержание)
